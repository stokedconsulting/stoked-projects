#!/bin/sh

# Pre-push hook: Prevent pushing if packages don't build or have type errors
# DO NOT SKIP THIS HOOK - See CLAUDE.md for policy

echo "========================================"
echo "  PRE-PUSH VALIDATION"
echo "========================================"
echo ""
echo "Running build and type checks via turbo..."
echo "This ensures no broken code is pushed to the repository."
echo ""

# Uses turbo caching â€” near-instant if already built.
# Covers all 3 packages: apps/code-ext, packages/api, packages/mcp-server.
if ! pnpm run compile 2>&1; then
    echo ""
    echo "========================================"
    echo "  PRE-PUSH VALIDATION FAILED"
    echo "========================================"
    echo ""
    echo "Push aborted. Fix the errors above before pushing."
    echo ""
    echo "NOTE: Skipping this hook is NOT allowed."
    echo "      See CLAUDE.md - 'You find it, you buy it' policy."
    echo ""
    exit 1
fi

echo ""
echo "========================================"
echo "  PRE-PUSH VALIDATION PASSED"
echo "========================================"
echo ""
echo "All packages build successfully. Proceeding with push..."
echo ""
exit 0
